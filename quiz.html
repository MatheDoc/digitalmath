<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz</title>
    
    <!-- Einbinden pdf Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <!-- Einbinden der externen CSS-Datei -->
    <link rel="stylesheet" href="styles.css"> 

    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.css">

     <!-- Font CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Select2 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />

    <!-- jQuery -->
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.js"></script>

    <!-- Select2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>

    <!-- MathJax Skript einbinden -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_HTML"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['\\(','\\)']],  // für inline Math (z.B. \( ... \))
                displayMath: [['\\[','\\]'], ['$$','$$']] // für Block Math (z.B. \[ ... \] oder $$ ... $$)
            },
            "HTML-CSS": {
                availableFonts: ["TeX"],
                linebreaks: { automatic: true }
            }
        });
    </script>

</head>
 
<body>
    <a href="https://mathedoc.github.io/digitalmath/index" class="link-homepage" title="home"><h1>Yes, we can math!</h1></a>  
    <h2>
        <i class="fas fa-paper-plane check-all-icon" title="Alle Fragen überprüfen" onclick="checkAllQuestions()"></i>
        <i class="fas fa-eye eye-icon" title="Lösungen anzeigen" onclick="showAllAnswers()"></i> 
        <i class="fas fa-file-pdf pdf-icon" title="PDF erstellen" onclick="printToPDF()"></i>
        <i class="fas fa-redo reload-icon" title="Neue Aufgabe anzeigen" onclick="window.location.reload();"></i>
    </h2>

    <h3 id="quiz-title"></h3>

    <div id="aufgabe"></div>

    <script>

             // Neue Funktion, um alle richtigen Antworten anzuzeigen
            function showAllAnswers() {
                document.querySelectorAll('input[type="text"]').forEach(input => {
                    const questionId = input.id.replace('answer', '');
                    const correctAnswer = input.getAttribute('data-correct-answer');
                    const feedbackElement = document.getElementById(`feedback${questionId}`);
                    feedbackElement.innerHTML = correctAnswer;
                    feedbackElement.style.color = "blue";
                    feedbackElement.style.opacity = 1;
                    input.style.display = "none";
                });

                document.querySelectorAll('select.mch').forEach(select => {
                    const questionId = select.id.replace('answer', '');
                    const correctAnswer = select.getAttribute('data-correct-answer');
                    const feedbackElement = document.getElementById(`feedback${questionId}`);
                    feedbackElement.innerHTML = correctAnswer;
                    feedbackElement.style.color = "blue";
                    feedbackElement.style.opacity = 1;
                    // Select2-Container ausblenden
                    const select2Container = select.nextElementSibling; // Nächstes Geschwisterelement nach select
                    if (select2Container && select2Container.classList.contains('select2')) {
                        select2Container.style.display = "none";
                    }
                });


                document.querySelectorAll('.check-icon').forEach(icon => {
                    icon.style.display = "none";
                });
            }


            function hideAllAnswers() {
                document.querySelectorAll('input[type="text"]').forEach(input => {
                    const questionId = input.id.replace('answer', '');
                    const feedbackElement = document.getElementById(`feedback${questionId}`);
                    feedbackElement.innerHTML = ''
                    input.style.display = "inline";
                });

                 document.querySelectorAll('select.mch').forEach(select => {
                    const questionId = select.id.replace('answer', '');
                    const feedbackElement = document.getElementById(`feedback${questionId}`);
                    feedbackElement.innerHTML = correctAnswer;
                    feedbackElement.style.color = '';
                      // Select2-Container einblenden
                    const select2Container = select.nextElementSibling; // Nächstes Geschwisterelement nach select
                    if (select2Container && select2Container.classList.contains('select2')) {
                        select2Container.style.display = "inline";
                    }
                });

                document.querySelectorAll('.check-icon').forEach(icon => {
                    icon.style.display = "inline";
                });
            }


        // pdf Export
        function printToPDF() {
            window.print(); // Öffnet das Druckdialogfenster des Browsers
        }

        let aufgabenZaehler = 1; // Initialisiere den Zähler
        let questionId = 1; // Eindeutige Frage-ID innerhalb einer Aufgabe

        function checkAnswer(questionId, correctAnswer, tolerance) {
            let userAnswerString = document.getElementById(`answer${questionId}`).value;
            let sanitizedUserAnswerString = userAnswerString.replace(/^=/, '').replace(',', '.').trim();
            const userAnswer = parseFloat(sanitizedUserAnswerString);
            const feedbackElement = document.getElementById(`feedback${questionId}`);

            if (!isNaN(userAnswer)) {
                if (Math.abs(userAnswer - correctAnswer) <= parseFloat(tolerance)) {
                    feedbackElement.innerHTML = 'Richtig! (Die genaue Antwort ist: ' + correctAnswer +')';
                    feedbackElement.style.color = "green";
                    return true
                } else {
                    feedbackElement.innerHTML = 'Falsch! Die richtige Antwort ist: ' + correctAnswer;
                    feedbackElement.style.color = "red";
                }
                feedbackElement.style.transition = "opacity 0.5s ease-in-out";
                feedbackElement.style.opacity = 1;
            } else {
                feedbackElement.textContent = "Ungültige Eingabe";
                feedbackElement.style.color = "orange";
            }
        }

        function checkMultipleChoiceAnswer(questionId, correctAnswer) {
            const userAnswer = document.getElementById(`answer${questionId}`).value;
            const feedbackElement = document.getElementById(`feedback${questionId}`);

            if (userAnswer) {
                if (userAnswer === correctAnswer) {
                    feedbackElement.innerHTML = 'Richtig!';
                    feedbackElement.style.color = "green";
                } else {
                    feedbackElement.innerHTML = 'Falsch! Die richtige Antwort ist: ' + correctAnswer;
                    feedbackElement.style.color = "red";
                }
                feedbackElement.style.transition = "opacity 0.5s ease-in-out";
                feedbackElement.style.opacity = 1;
            } else {
                feedbackElement.textContent = "Bitte eine Auswahl treffen";
                feedbackElement.style.color = "orange";
            }
        }

        function checkAllQuestions() {
            let correctCount = 0; // Zähler für korrekte Antworten
            let totalCount = 0; // Gesamtzahl der Fragen

            // Alle numerischen Antworten überprüfen
            document.querySelectorAll('input[type="text"]').forEach(input => {
                totalCount++; // Erhöhe die Gesamtzahl der Fragen
                const questionId = input.id.replace('answer', '');
                const correctAnswer = input.getAttribute('data-correct-answer');
                const tolerance = input.getAttribute('data-tolerance');
                
                // Überprüfe die Antwort und zähle korrekt
                if (checkAnswer(questionId, parseFloat(correctAnswer), parseFloat(tolerance))) {
                    correctCount++; // Erhöhe den Zähler für korrekte Antworten
                }
            });

            // Alle Multiple-Choice-Antworten überprüfen
            document.querySelectorAll('select.mch').forEach(select => {
                totalCount++;
                const questionId = select.id.replace('answer', '');
                const correctAnswer = select.getAttribute('data-correct-answer');
                
                // Überprüfe die Antwort und zähle korrekt
                if (checkMultipleChoiceAnswer(questionId, correctAnswer)) {
                    correctCount++;
                }
            });

            // Zeige die Gesamtbewertung an
            if (totalCount > 0) { // Sicherstellen, dass Fragen vorhanden sind
                // Hintergrundfarbe basierend auf der Anzahl der richtigen Antworten ändern
                if (correctCount === totalCount) {
                    document.body.style.backgroundColor = "#c1fdbd"; // Alle richtig
                } else {
                    document.body.style.backgroundColor = "#fdbdbd"; // Nicht alle richtig
                }
            } else {
                alert("Es wurden keine Fragen gefunden."); // Nachricht, wenn keine Fragen vorhanden sind
            }
        }





        function replaceNumericalWithInteractive(htmlContent) {
            const pattern = /\{\d+:NUMERICAL:=(-?[0-9.,]+):([0-9.,]+)\}/g;
            function replacer(match, correctAnswer, tolerance) {
                const interactiveHtml = `
                    <input type="text" id="answer${questionId}" placeholder="Antwort" data-correct-answer="${correctAnswer.replace(',', '.')}" data-tolerance="${tolerance.replace(',', '.')}">
                    <i class="fas fa-paper-plane check-icon "title="Frage überprüfen" onclick="checkAnswer(${questionId}, ${correctAnswer.replace(',', '.')}, ${tolerance.replace(',', '.')})"></i>
                    <span id="feedback${questionId}"></span>
                `;
                questionId++; // Eindeutige ID für jede Frage
                return interactiveHtml;
            }
            return htmlContent.replace(pattern, replacer);
        }

        function replaceMultipleChoiceWithDropdown(htmlContent) {
            const pattern = /\{\d+:MCH:([^}]*)\}/g;
            
            function replacer(match, optionsString) {
                const options = optionsString.split('~');
                const correctAnswer = options.find(option => option.startsWith('='))?.substring(1).trim();

                const optionsHtml = options.map(option => {
            const isCorrect = option.startsWith('=');
            const trimmedOption = isCorrect ? option.substring(1).trim() : option.trim();  // Entfernen von `=`
            return `<option value="${trimmedOption}">${trimmedOption}</option>`;
        }).join('');

                const interactiveHtml = `
                    <select id="answer${questionId}" class="mch" data-correct-answer="${correctAnswer}">
                        ${optionsHtml}
                    </select>
                    <i class="fas fa-paper-plane check-icon" onclick="checkMultipleChoiceAnswer(${questionId}, '${correctAnswer}')"></i>
                    <span id="feedback${questionId}"></span>
                `;
                questionId++; 
                return interactiveHtml;
            }

            return htmlContent.replace(pattern, replacer);
        }

        // Event-Listener für alle Check-Icons dynamisch hinzufügen
        function addCheckIconListeners() {
            document.querySelectorAll('.check-icon, .check-all-icon, .eye-icon').forEach(icon => {
                icon.addEventListener('click', function() {
                    const checkAllIcon = document.querySelector('.check-all-icon'); 
                    if (checkAllIcon) {
                        checkAllIcon.style.color = '#7e7e7e'
                        checkAllIcon.onclick = null
                        checkAllIcon.title = " "
                        checkAllIcon.style.cursor = "auto"
                    }
                });
            });
        }


        function zeigeNeueAufgabe() {
            const params = new URLSearchParams(window.location.search);
            const sammlungen = params.getAll('sammlung');
            const titel = params.get('titel');
            // Prüfen, ob der Parameter vorhanden ist, und als <h2> anzeigen
            if (titel) {
                const h3Element = document.getElementById('quiz-title');
                h3Element.textContent += ' ' + titel; // Titel anhängen
            }

            if (sammlungen.length > 0) {
                // Eine zufällige Sammlung auswählen
                const zufaelligeSammlung = sammlungen[Math.floor(Math.random() * sammlungen.length)];

                // Aufgabe aus der zufällig ausgewählten Sammlung laden
                fetch(`Aufgaben/JSON/${zufaelligeSammlung}`)
                    .then(response => response.json())
                    .then(data => zeigeZufaelligeAufgabeAusSammlung(zufaelligeSammlung, data))
                    .catch(error => {
                        console.error(`Fehler beim Laden der JSON-Datei für ${zufaelligeSammlung}:`, error);
                        document.getElementById('aufgabe').innerHTML = `<p>Es gab ein Problem beim Laden der Aufgaben aus der Sammlung ${zufaelligeSammlung}.</p>`;
                    });
            } else {
                console.error('Keine Sammlung in der URL gefunden.');
                document.getElementById('aufgabe').innerText = 'Keine Sammlung gefunden.';
            }
        }

        function zeigeZufaelligeAufgabeAusSammlung(sammlung, aufgaben) {
            if (aufgaben.length > 0) {
                const randomIndex = Math.floor(Math.random() * aufgaben.length);
                const selectedTask = aufgaben[randomIndex];

                const aufgabeContainer = document.getElementById('aufgabe');
                let htmlContent =
                    `<div class="einleitung">
                        <p>${selectedTask.einleitung}</p>
                    </div>
                    <div class="nachfolgend">
                        <ol aria-label>`;

                selectedTask.fragen.forEach((frage, index) => {
                    htmlContent += `<li><span class="frage">${frage}</span><br><span class="antwort">${selectedTask.antworten[index]}</span></li>`;
                });

                htmlContent += `</ol>
                    </div>`;

                const aufgabenElement = document.createElement('div');
                aufgabenElement.id = `aufgabe-${aufgabenZaehler}`;
                var interactiveHtml = replaceNumericalWithInteractive(htmlContent);
                interactiveHtml = replaceMultipleChoiceWithDropdown(interactiveHtml);
                aufgabenElement.innerHTML = interactiveHtml;
                aufgabeContainer.appendChild(aufgabenElement);

                // Select2 Initialisierung
                $(`#aufgabe-${aufgabenZaehler} select.mch`).select2({
                    placeholder: "Antwort",
                    minimumResultsForSearch: Infinity,
                    width: 'auto'
                });

                MathJax.Hub.Queue(["Typeset", MathJax.Hub, aufgabeContainer]);

                aufgabenZaehler++;
                        // Füge die Listener für die Check-Icons hinzu

        addCheckIconListeners();
            } else {
                console.error(`Keine Aufgaben in der Sammlung ${sammlung} gefunden.`);
                document.getElementById('aufgabe').innerHTML += `<p>Keine Aufgaben in der Sammlung ${sammlung} gefunden.</p>`;
            }
        }


        // Initiales Laden einer zufälligen Aufgabe
        zeigeNeueAufgabe();
    </script>  
</body>
</html>
