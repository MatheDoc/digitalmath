<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aufgaben mit JavaScript</title>
    
    <!-- Einbinden der externen CSS-Datei -->
    <link rel="stylesheet" href="styles.css"> 
    <!-- MathJax Skript einbinden -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_HTML"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['\\(','\\)']],  // für inline Math (z.B. \( ... \))
                displayMath: [['\\[','\\]'], ['$$','$$']] // für Block Math (z.B. \[ ... \] oder $$ ... $$)
            },
            "HTML-CSS": {
                availableFonts: ["TeX"],
                linebreaks: { automatic: true }
            }
        });
    </script>

</head>
 
<body>
    <h1>Yes, we can math!</h1>
    
    <div id="aufgabe"></div>

    <script>
        function checkAnswer(questionId, correctAnswer, tolerance) {
            const userAnswer = parseFloat(document.getElementById(`answer${questionId}`).value);
            const feedbackElement = document.getElementById(`feedback${questionId}`);

            if (!isNaN(userAnswer)) {
                if (Math.abs(userAnswer - correctAnswer) <= parseFloat(tolerance)) {
                    feedbackElement.textContent = "Richtig!";
                    feedbackElement.style.color = "green";
                } else {
                    feedbackElement.textContent = "Falsch! Die richtige Antwort ist: " + correctAnswer;
                    feedbackElement.style.color = "red";
                }
                feedbackElement.style.transition = "opacity 0.5s ease-in-out";
                feedbackElement.style.opacity = 1;
            } else {
                feedbackElement.textContent = "Bitte eine gültige Zahl eingeben.";
                feedbackElement.style.color = "orange";
            }
        }

        function replaceNumericalWithInteractive(htmlContent) {
            let questionId = 1;
            const pattern = /\{\d+:NUMERICAL:=(-?[0-9.,]+):([0-9.,]+)\}/g;
            function replacer(match, correctAnswer, tolerance) {
                const interactiveHtml = `
                    <input type="number" id="answer${questionId}" placeholder="Antwort">
                    <button onclick="checkAnswer(${questionId}, ${correctAnswer.replace(',', '.')}, ${tolerance.replace(',', '.')})">Überprüfen</button>
                    <span id="feedback${questionId}"></span>
                `;
                questionId++;
                return interactiveHtml;
            }
            return htmlContent.replace(pattern, replacer);
        }

        function zeigeNeueAufgabe() {
            const params = new URLSearchParams(window.location.search);
            const sammlungen = params.getAll('sammlung'); // Holt alle Sammlungen aus der URL

            if (sammlungen.length > 0) {
                // Für jede Sammlung eine Anfrage senden und Aufgaben anzeigen
                sammlungen.forEach(sammlung => {
                    fetch(`Aufgaben/JSON/${sammlung}`)
                        .then(response => response.json())
                        .then(data => zeigeZufaelligeAufgabeAusSammlung(sammlung, data))
                        .catch(error => {
                            console.error(`Fehler beim Laden der JSON-Datei für ${sammlung}:`, error);
                            document.getElementById('aufgabe').innerHTML += `<p>Es gab ein Problem beim Laden der Aufgaben aus der Sammlung ${sammlung}.</p>`;
                        });
                });
            } else {
                console.error('Keine Sammlung in der URL gefunden.');
                document.getElementById('aufgabe').innerText = 'Keine Sammlung gefunden.';
            }
        }

        function zeigeZufaelligeAufgabeAusSammlung(sammlung, aufgaben) {
            if (aufgaben.length > 0) {
                const randomIndex = Math.floor(Math.random() * aufgaben.length);
                const selectedTask = aufgaben[randomIndex];

                // Erstelle HTML-Elemente für jede Sammlung und füge die Aufgabe hinzu
                const aufgabeContainer = document.getElementById('aufgabe');
                let htmlContent =
                    `<div id="task-${selectedTask.id}"><h2>Test</h2><div class="einleitung">
                        <button class="neueAufgabe" onclick="zeigeNeueAufgabe()">Neu</button><br>
                        <p>${selectedTask.einleitung}</p>
                    </div>
                    <div class="nachfolgend">
                        <ol aria-label="Liste von Aufgaben">`;

                selectedTask.fragen.forEach((frage, index) => {
                    htmlContent += `<li>${frage}<br>${selectedTask.antworten[index]}</li>`;
                });

                htmlContent += `</ol>
                    </div>`;

                // Füge das erstellte HTML der Seite hinzu
                const aufgabenElement = document.createElement('div');
                aufgabenElement.innerHTML = replaceNumericalWithInteractive(htmlContent);
                aufgabeContainer.appendChild(aufgabenElement);

                // MathJax Neurendering auslösen (falls MathJax benötigt wird)
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, aufgabeContainer]);
            } else {
                console.error(`Keine Aufgaben in der Sammlung ${sammlung} gefunden.`);
                document.getElementById('aufgabe').innerHTML += `<p>Keine Aufgaben in der Sammlung ${sammlung} gefunden.</p>`;
            }
        }



        // Initiales Laden einer zufälligen Aufgabe
        zeigeNeueAufgabe();
    </script>  
</body>
</html>
